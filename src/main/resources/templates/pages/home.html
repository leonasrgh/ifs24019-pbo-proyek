<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/base}"
  lang="id"
>
  <head>
    <title>Dashboard - Nutrition App</title>
  </head>

  <body>
    <!-- Konten Utama -->
    <div layout:fragment="content" class="container py-5">
      <!-- Header Dashboard -->
      <div class="row mb-4">
        <div class="col">
          <h1 class="display-4">üçé Dashboard Nutrisi</h1>
          <p class="lead">
          Selamat datang, <strong th:text="${auth != null ? auth.name : 'Pengunjung'}">User</strong>!
          </p>
        </div>
        <div class="col-auto">
          <a th:href="@{/foods}" class="btn btn-primary btn-lg">
            üìã Lihat Semua Makanan
          </a>
          <a th:href="@{/foods/statistics}" class="btn btn-success btn-lg">
            üìä Statistik Nutrisi
          </a>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row g-4 mb-5">
        <div class="col-md-3">
          <div class="card text-center shadow-sm">
            <div class="card-body">
              <h3 class="display-4 text-primary" th:text="${foods.size()}">0</h3>
              <p class="text-muted mb-0">Total Makanan</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card text-center shadow-sm">
            <div class="card-body">
              <h3 
                class="display-4 text-danger" 
                th:text="${statistics != null and statistics.averageNutrition != null and statistics.averageNutrition.get('calories') != null ? #numbers.formatDecimal(statistics.averageNutrition.get('calories'), 0, 0) : '0'}"
              >0</h3>
              <p class="text-muted mb-0">Rata-rata Kalori</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card text-center shadow-sm">
            <div class="card-body">
              <h3 
                class="display-4 text-success" 
                th:text="${statistics != null and statistics.averageNutrition != null and statistics.averageNutrition.get('protein') != null ? #numbers.formatDecimal(statistics.averageNutrition.get('protein'), 0, 1) : '0'}"
              >0</h3>
              <p class="text-muted mb-0">Rata-rata Protein (g)</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card text-center shadow-sm">
            <div class="card-body">
              <h3 
                class="display-4 text-warning" 
                th:text="${statistics != null and statistics.countByCategory != null ? statistics.countByCategory.size() : '0'}"
              >0</h3>
              <p class="text-muted mb-0">Kategori Makanan</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Charts -->
      <div class="row g-4 mb-5">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">üìä Kalori per Kategori</h5>
              <canvas id="caloriesByCategoryChart" height="250"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">üçΩÔ∏è Jumlah Makanan per Kategori</h5>
              <canvas id="countByCategoryChart" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Foods -->
      <div class="row">
        <div class="col">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>üçΩÔ∏è Makanan Terbaru</h2>
            <button
              type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addFoodModal"
            >
              ‚ûï Tambah Makanan
            </button>
          </div>

          <div class="row g-3">
            <div
              th:each="food, iterStat : ${foods}"
              th:if="${iterStat.index < 8}"
              class="col-md-3"
            >
              <div class="card h-100 shadow-sm">
                <img
                  th:if="${food.cover}"
                  th:src="@{'/foods/cover/' + ${food.cover}}"
                  class="card-img-top"
                  th:alt="${food.name}"
                  style="height: 150px; object-fit: cover"
                />
                <img
                  th:unless="${food.cover}"
                  src="https://via.placeholder.com/300x150?text=No+Image"
                  class="card-img-top"
                  alt="No image"
                  style="height: 150px; object-fit: cover"
                />
                <div class="card-body">
                  <span
                    class="badge bg-primary mb-2"
                    th:text="${food.category}"
                    >Category</span
                  >
                  <h6 class="card-title" th:text="${food.name}">Food Name</h6>
                  <p class="card-text small text-muted">
                    üî• <strong th:text="${food.calories}">0</strong> kcal | üí™
                    <strong th:text="${food.protein}">0</strong>g
                  </p>
                  <a
                    th:href="@{'/foods/' + ${food.id}}"
                    class="btn btn-sm btn-outline-primary"
                  >
                    Detail
                  </a>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div th:if="${foods.empty}" class="col-12">
              <div class="alert alert-info text-center" role="alert">
                <h4>üçΩÔ∏è Belum ada makanan</h4>
                <p>Mulai tambahkan makanan pertama Anda!</p>
                <button
                  type="button"
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#addFoodModal"
                >
                  ‚ûï Tambah Makanan
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Add Food - INLINE -->
      <div class="modal fade" id="addFoodModal" tabindex="-1" aria-labelledby="addFoodModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form th:action="@{/foods/add}" method="post" th:object="${foodForm}">
              <!-- Modal Header -->
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addFoodModalLabel">‚ûï Tambah Makanan Baru</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <!-- Modal Body -->
              <div class="modal-body">
                <div class="row g-3">
                  <!-- Nama Makanan -->
                  <div class="col-md-6">
                    <label for="name" class="form-label">Nama Makanan <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="name" name="name" th:field="*{name}" placeholder="Contoh: Nasi Putih" required />
                  </div>

                  <!-- Kategori -->
                  <div class="col-md-6">
                    <label for="category" class="form-label">Kategori <span class="text-danger">*</span></label>
                    <select class="form-select" id="category" name="category" th:field="*{category}" required>
                      <option value="">Pilih Kategori</option>
                      <option value="Buah">üçé Buah</option>
                      <option value="Sayuran">ü•ó Sayuran</option>
                      <option value="Protein">üçó Protein</option>
                      <option value="Karbohidrat">üçö Karbohidrat</option>
                      <option value="Lemak Sehat">ü•ë Lemak Sehat</option>
                    </select>
                  </div>

                  <!-- Ukuran Porsi -->
                  <div class="col-md-6">
                    <label for="servingSize" class="form-label">Ukuran Porsi <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="servingSize" name="servingSize" th:field="*{servingSize}" placeholder="Contoh: 100g, 1 mangkuk" required />
                  </div>

                  <!-- Kalori -->
                  <div class="col-md-6">
                    <label for="calories" class="form-label">Kalori (kcal) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="calories" name="calories" th:field="*{calories}" step="0.1" min="0" placeholder="Contoh: 130" required />
                  </div>

                  <!-- Protein -->
                  <div class="col-md-3">
                    <label for="protein" class="form-label">Protein (g) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="protein" name="protein" th:field="*{protein}" step="0.1" min="0" placeholder="0" required />
                  </div>

                  <!-- Karbohidrat -->
                  <div class="col-md-3">
                    <label for="carbohydrates" class="form-label">Karbo (g) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="carbohydrates" name="carbohydrates" th:field="*{carbohydrates}" step="0.1" min="0" placeholder="0" required />
                  </div>

                  <!-- Lemak -->
                  <div class="col-md-3">
                    <label for="fat" class="form-label">Lemak (g) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="fat" name="fat" th:field="*{fat}" step="0.1" min="0" placeholder="0" required />
                  </div>

                  <!-- Serat -->
                  <div class="col-md-3">
                    <label for="fiber" class="form-label">Serat (g) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="fiber" name="fiber" th:field="*{fiber}" step="0.1" min="0" placeholder="0" required />
                  </div>

                  <!-- Deskripsi -->
                  <div class="col-12">
                    <label for="description" class="form-label">Deskripsi (Opsional)</label>
                    <textarea class="form-control" id="description" name="description" th:field="*{description}" rows="3" placeholder="Tambahkan deskripsi atau catatan tentang makanan ini..."></textarea>
                  </div>
                </div>

                <div class="alert alert-info mt-3" role="alert">
                  <small><strong>üí° Tips:</strong> Pastikan nilai nutrisi sudah sesuai dengan ukuran porsi yang Anda masukkan.</small>
                </div>
              </div>

              <!-- Modal Footer -->
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-primary">‚ûï Tambah Makanan</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <th:block layout:fragment="others-js">
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script th:inline="javascript">
        /*<![CDATA[*/
        // Data dari server
        const statistics = /*[[${statistics}]]*/ {};

        // Chart 1: Calories by Category (Bar Chart)
        if (statistics && statistics.caloriesByCategory && Object.keys(statistics.caloriesByCategory).length > 0) {
          const caloriesCtx = document.getElementById("caloriesByCategoryChart").getContext("2d");
          new Chart(caloriesCtx, {
            type: "bar",
            data: {
              labels: Object.keys(statistics.caloriesByCategory),
              datasets: [{
                label: "Total Kalori (kcal)",
                data: Object.values(statistics.caloriesByCategory),
                backgroundColor: [
                  "rgba(255, 99, 132, 0.7)",
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(255, 206, 86, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                ],
                borderWidth: 2,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true } },
            },
          });
        } else {
          const chartContainer = document.getElementById("caloriesByCategoryChart").parentElement;
          chartContainer.innerHTML = '<p class="text-muted text-center py-5">üìä Belum ada data. Tambahkan makanan untuk melihat chart.</p>';
        }

        // Chart 2: Count by Category (Doughnut Chart)
        if (statistics && statistics.countByCategory && Object.keys(statistics.countByCategory).length > 0) {
          const countCtx = document.getElementById("countByCategoryChart").getContext("2d");
          new Chart(countCtx, {
            type: "doughnut",
            data: {
              labels: Object.keys(statistics.countByCategory),
              datasets: [{
                label: "Jumlah Makanan",
                data: Object.values(statistics.countByCategory),
                backgroundColor: [
                  "rgba(255, 99, 132, 0.7)",
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(255, 206, 86, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                ],
                borderColor: "#fff",
                borderWidth: 2,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: "bottom" } },
            },
          });
        } else {
          const chartContainer = document.getElementById("countByCategoryChart").parentElement;
          chartContainer.innerHTML = '<p class="text-muted text-center py-5">üìä Belum ada data. Tambahkan makanan untuk melihat chart.</p>';
        }

        // Auto-show modal jika ada error
        const addModalOpen = /*[[${addFoodModalOpen}]]*/ false;
        if (addModalOpen) {
          const addModal = new bootstrap.Modal(document.getElementById("addFoodModal"));
          addModal.show();
        }
        /*]]>*/
      </script>
    </th:block>
  </body>
</html>